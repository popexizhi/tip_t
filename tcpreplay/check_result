#!/bin/bash

check_log()
{
    res_log=$1
    echo "***********************check_log::${res_log}"
    pre_count=`cat ${res_log}|grep "Actual:"|sed 's/Actual: //g'|sed 's/ .*//g'`
    echo "pre_count:${pre_count}"
    t_count="process_count" 
    t_type="capture"
    #t_type="sensor"
    check_stat_log $1 $pre_count $t_type 
}

check_stat_log()
{
    res_log=$1
    pre_count=$2
    t_type=$3
    t_count="process_count" 
    start_count=`head -n 1 ${res_log}|grep "{\"${t_count}\""|sed "s/.*${t_type}\":{\"${t_count}\"://g"|sed 's/,.*//g'`
    #echo "start_count:${start_count}"
    if [[ ${start_count} == '{"Lock":{}' ]];then
        start_count=0
    fi
    end_count=`tail -n 1 ${res_log}|grep "{\"${t_count}\""|sed "s/.*${t_type}\":{\"${t_count}\"://g"|sed 's/,.*//g'`

    curl_count_all=$((end_count - start_count))
    echo "${end_count} - ${start_count} = ${curl_count_all}"
    resdiff=$((pre_count-curl_count_all))
    resper=`awk 'BEGIN{printf "%.3f%\n",('${curl_count_all}'/'${pre_count}')*100}'`
    resperC=`awk 'BEGIN{printf "%.3f%\n",('${curl_count_all}'/('${pre_count}'*1.2))*100}'`
    echo "[res]${resdiff}:${resperC}[${resper}]"
    RES="${RES} \n ${res_log}:[${resdiff}:${resper}]"
}

check_complex_log()  #check complex result
{
    res_log=$1
    check_tcpdump_logs ${res_log}
    if [[ ${pre_count} == "" ]];then
        echo "\${pre_count} is null ,err"
        exit -1
    fi
    t_type="capture"
    check_stat_log $1 ${pre_count} ${t_type}
}

check_tcpdump_logs()
{
    res_log=$1
       
    pre_count_http=`cat ${res_log}_http|grep "Actual:"|sed 's/Actual: //g'|sed 's/ .*//g'`
    pre_count_dns=`cat ${res_log}_dns|grep "Actual:"|sed 's/Actual: //g'|sed 's/ .*//g'`
    pre_count=$((pre_count_http + pre_count_dns))
    echo "http_pre[${pre_count_http}];dns_pre[${pre_count_dns}];pre_count[${pre_count}]"
}



check_out()
{
    res_log=$1
    echo "***********************check_out::${res_log}"
    type_str='"type":"dns"'
    out_num=`cat $1|grep ${type_str}|wc -l`
    out_num_dns=${out_num}

    type_str='"type":"http"'
    out_num=`cat $1|grep ${type_str}|wc -l`
    out_num_http=${out_num}

    echo "out_num_dns:${out_num_dns};out_num_http:${out_num_http}"
    RES="${RES} \n${res_log}[out_num_dns:${out_num_dns};out_num_http:${out_num_http}]"

}

get_res_dir() 
{
    RES=""
    #BASEPH="/fileserver"
    BASEPH="/fileserver/sensor"
    for dir in `ls -all ${BASEPH}/|grep "DNS"|awk '{print $9}'`
    do
        res_log=`ls ${BASEPH}/${dir}|grep log`
        res_log="${BASEPH}/${dir}/${res_log}"
        res_out=`ls ${BASEPH}/${dir}|grep out`
        res_out="${BASEPH}/${dir}/${res_out}"

        echo "${res_log}---${res_out}" 
        check_log ${res_log}
        #check_out ${res_out}
    done
    echo -e $RES
}


#check_log $1
#get_res_dir 
check_complex_log $1  #check complex result
#check_out $1/test_tip.out
